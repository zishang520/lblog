!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("object"==typeof exports?require("jquery"):jQuery)}(function(t){"use strict";function a(a){this.$container=a,this.$avatarView=this.$container.find(".picture"),this.$btn=this.$avatarView.find(".btn"),this.$avatar=this.$avatarView.find("img"),this.$avatarModal=t("#avatar-modal"),this.$loading=t(".alert-laoding"),this.$picturefile=this.$avatarView.find("#picturefile"),this.$avatarForm=this.$avatarModal.find(".avatar-form"),this.$avatarUpload=this.$avatarForm.find(".avatar-upload"),this.$avatarSrc=this.$avatarForm.find(".avatar-src"),this.$avatarData=this.$avatarForm.find(".avatar-data"),this.$avatarInput=this.$avatarForm.find(".avatar-input"),this.$avatarSave=this.$avatarForm.find(".avatar-save"),this.$avatarBtns=this.$avatarForm.find(".avatar-btns"),this.$avatarWrapper=this.$avatarModal.find(".avatar-wrapper"),this.$avatarPreview=this.$avatarModal.find(".avatar-preview"),this.init()}var i=window.console||{log:function(){}};a.prototype={constructor:a,support:{fileList:!!t('<input type="file">').prop("files"),blobURLs:!!window.URL&&URL.createObjectURL,formData:!!window.FormData},init:function(){this.support.datauri=this.support.fileList&&this.support.blobURLs,this.support.formData||this.initIframe(),this.initTooltip(),this.initModal(),this.addListener()},addListener:function(){this.$avatarView.on("click",t.proxy(this.click,this)),this.$avatarInput.on("change",t.proxy(this.change,this)),this.$avatarForm.on("submit",t.proxy(this.submit,this)),this.$avatarBtns.on("click",t.proxy(this.rotate,this))},initTooltip:function(){this.$avatarView.tooltip({placement:"right"})},initModal:function(){this.$avatarModal.modal({show:!1})},initPreview:function(){var t=this.$avatarWrapper.find("img.cropper-hidden"),a=1==t.length?t.attr("src"):"";""==a||this.$avatarPreview.empty().html('<img src="'+a+'">')},initIframe:function(){var a="upload-iframe-"+(new Date).getTime(),r=t("<iframe>").attr({name:a,src:""}),e=this;r.one("load",function(){r.on("load",function(){var a;try{a=t(this).contents().find("body").text()}catch(r){i.log(r.message)}if(a){try{a=t.parseJSON(a)}catch(r){i.log(r.message)}e.submitDone(a)}else e.submitFail("Image upload failed!");e.submitEnd()})}),this.$iframe=r,this.$avatarForm.attr("target",a).after(r.hide())},click:function(){this.$avatarModal.modal("show"),this.initPreview()},change:function(){var t,a;this.support.datauri?(t=this.$avatarInput.prop("files"),t.length>0&&(a=t[0],this.isImageFile(a)&&(this.url&&URL.revokeObjectURL(this.url),this.url=URL.createObjectURL(a),this.startCropper()))):(a=this.$avatarInput.val(),this.isImageFile(a)&&this.syncUpload())},submit:function(){var t,a;return this.$avatarSrc.val()||this.$avatarInput.val()?(t=this.$avatarInput.prop("files"),t.length>0&&(a=t[0]),this.isImageFile(a)?parseInt(a.size)>=2097152?(this.alert("图片不能超过2MB,当前大小"+this.SizeConvert(parseInt(a.size))),!1):this.support.formData?(this.ajaxUpload(),!1):!1:(this.alert("图片格式不正确"),!1)):(this.alert("请选择你要上传的图片"),!1)},rotate:function(a){var i;this.active&&(i=t(a.target).data(),i.method&&this.$img.cropper(i.method,i.option))},isImageFile:function(t){return t.type?/^image\/\w+$/.test(t.type):/\.(jpg|jpeg|png|gif)$/.test(t)},startCropper:function(){var a=this;this.active?this.$img.cropper("replace",this.url):(this.$img=t('<img src="'+this.url+'">'),this.$avatarWrapper.empty().html(this.$img),this.$img.cropper({preview:this.$avatarPreview.selector,strict:!1,aspectRatio:1,autoCropArea:1,viewMode:1,crop:function(t){var i=['{"x":'+t.x,'"y":'+t.y,'"height":'+t.height,'"width":'+t.width,'"rotate":'+t.rotate+"}"].join();a.$avatarData.val(i)}}),this.active=!0)},stopCropper:function(){this.active&&(this.$img.cropper("destroy"),this.$img.remove(),this.active=!1)},ajaxUpload:function(){var a=this.$avatarForm.attr("action"),i=new FormData(this.$avatarForm[0]),r=this;t.ajax(a,{type:"post",data:i,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){r.submitStart()},success:function(t){r.submitDone(t),r.$avatarSave.button("reset")},error:function(t,a,i){r.submitFail(a||i)}})},syncUpload:function(){this.$avatarSave.click()},submitStart:function(){this.$avatarSave.button("loading")},submitDone:function(a){t.isPlainObject(a)?a.status?(this.path=a.url,this.support.datauri||this.uploaded?(this.uploaded=!1,this.cropDone()):(this.uploaded=!0,this.$avatarSrc.val(this.path),this.startCropper()),this.$avatarInput.val("")):a.message&&this.alert(a.message):this.alert("Failed to response")},submitFail:function(t){this.alert(t)},submitEnd:function(){this.$avatarSave.button("reset")},cropDone:function(){this.$avatarForm.get(0).reset(),i.log(this.path),this.$avatar.attr("src",this.path+"?"+Math.random()),this.$picturefile.val(this.url),this.stopCropper(),this.$avatarModal.modal("hide")},alert:function(t){var a=this;a.submitStart(),window.ShowMsg('<span class="text text-warning">'+t+"</span>",!0,function(){a.submitEnd()})},SizeConvert:function(t){var a,i,r=parseInt(t);return r>=1073741824?(i=parseInt(r/1073741824*1e3)/1e3,a=i+" GB"):r>=1048576?(i=parseInt(r/1048576*1e3)/1e3,a=i+" MB"):r>=1024?(i=parseInt(r/1024*1e3)/1e3,a=i+" KB"):a=r+" Byte",a}},t(function(){return new a(t("#crop-avatar"))})});